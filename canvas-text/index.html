<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Document</title>
    <style>
        body {
            margin: 0;
        }

        .text_control_container {
            position: absolute;
            background-color: antiquewhite;
            padding: 12px;
            width: 100px;
            height: 50px;
        }

        @font-face {
            font-family: 'MyFont';
            src: url(https://d1eex2z7lomdjl.cloudfront.net/fonts/jester.ttf);
        }
    </style>
</head>

<body>
    <canvas id="myCanvas" name="myCanvas" width="1000" height="500" style="border:1px dotted;float:left"></canvas>


    <div class="text_control_container">
        <label for="font-control">Font family:</label>
        <select id="font-control" name="font-control">
            <option value="Arial">Arial</option>
            <option value="Times New Roman">Times</option>
            <option value="HanziPen TC">HanziPen</option>
            <option value="Libian TC">Libian</option>
            <option value="MyFont">MyFont</option>
        </select>
    </div>

</body>

</html>
<script src="../script/jquery-3.3.1.min.js"></script>
<script src="fabric.js"></script>
<script src="canvas-text.js"></script>
<script type="text/javascript">
    var canvas;
    var textControl;
    var selectedObj;

    $(document).ready(function() {
        init();
        addText();
        addText1();
    });

    function init() {
        initCanvas();
        initTextControl();
        selectedObject(null);
        canvas.renderAll();

        function initCanvas() {
            canvas = new fabric.Canvas('myCanvas', {});

            fabric.Canvas.prototype.getAbsoluteCoords = function(object) {
                return {
                    left: object.left + this._offset.left,
                    top: object.top + this._offset.top
                };
            }

            canvas.on('selection:cleared', function() {
                console.log("canvas selection cleared");
                selectedObject(null);
            });

        }

        function initTextControl() {
            textControl = $('.text_control_container');
        }
    };

    function addText() {
        var text = new fabric.IText('我是誰 小拳石', {
            fontFamily: 'HanziPen TC',
            left: 100,
            top: 100,
        });

        canvas.add(text);

        text.on('moving', function() {
            positionTextControl(text)
        });
        text.on('scaling', function() {
            positionTextControl(text)
        });

        text.on('mouseup', function() {
            console.log("text mouseup");
            selectedObject(text);
        });
    }

    function addText1() {
        var text = new fabric.IText('我是誰 皮卡丘', {
            fontFamily: 'Libian TC',
            left: 50,
            top: 50,
        });

        canvas.add(text);

        text.on('moving', function() {
            positionTextControl(text)
        });
        text.on('scaling', function() {
            positionTextControl(text)
        });

        text.on('mouseup', function() {
            console.log("text mouseup");
            selectedObject(text);
        });
    }

    function changeFont(obj, fontName) {
        obj.fontFamily = fontName;
        canvas.renderAll();
    }

    function selectedObject(obj) {
        selectedObj = obj;
        if (obj == null) {
            textControl.hide();
            return;
        }
        textControl.show();
        positionTextControl(obj);
    }

    function positionTextControl(obj) {
        let absCoords = canvas.getAbsoluteCoords(obj);
        let width = obj.width * obj.scaleX;
        let height = obj.height * obj.scaleY;

        textControl.css({
            "top": absCoords.top,
            "left": absCoords.left + width
        });
    }

    var fontControl = $('#font-control');
    $(document.body).on('change', '#font-control', function() {
        if (selectedObj != null) {
            selectedObj.fontFamily = fontControl.val();
            canvas.renderAll();
        }
    });
</script>