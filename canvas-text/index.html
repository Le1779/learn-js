<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Document</title>
    <link rel="stylesheet" href="add-text-button.css">
    <style>
        body {
            margin: 0;
        }

        .text_control_container {
            position: absolute;
            background-color: antiquewhite;
            padding: 12px;
        }
        

        .color{
            width: 20px;
            height: 20px;
            border-radius: 10px;
            display: inline-block;
            cursor: pointer;
        }
        
        .red{
            background-color: #ff4040;
        }
        
        .orange{
            background-color: #ff6518;
        }
        
        .yellow{
            background-color: #ffbb3b;
        }
        
        .green{
            background-color: #03bd9e;
        }
        
        .light_blue{
            background-color: #00a9ff;
        }
        
        .blue{
            background-color: #515ce6;
        }
        
        .purple{
            background-color: #9e5fff;
        }
        
        .pink{
            background-color: #ff5583;
        }
        
        .white{
            background-color: #ffffff;
        }
        
        .black{
            background-color: #000000;
        }
        
        @font-face {
            font-family: 'MyFont';
            src: url(https://d1eex2z7lomdjl.cloudfront.net/fonts/jester.ttf);
        }
    </style>
</head>

<body>
    <canvas id="myCanvas" name="myCanvas" width="1000" height="500" style="border:1px dotted;float:left"></canvas>

    <div class="addText" style="left: 950px; top: 10px;"></div>

    <div class="text_control_container">
        <div>
            <label for="font-control">Font family:</label>
            <select id="font-control" name="font-control">
                <option value="Arial">Arial</option>
                <option value="Times New Roman">Times</option>
                <option value="HanziPen TC">HanziPen</option>
                <option value="Libian TC">Libian</option>
                <option value="MyFont">MyFont</option>
            </select>
        </div>

        <div>
            <label>Text color:</label>
            <div class="text_color_container">
                <div class="color white"></div>
                <div class="color black"></div>
                <div class="color red"></div>
                <div class="color orange"></div>
                <div class="color yellow"></div>
                <div class="color green"></div>
                <div class="color light_blue"></div>
                <div class="color blue"></div>
                <div class="color purple"></div>
                <div class="color pink"></div>
            </div>
        </div>
    </div>

</body></html>
<script src="../script/jquery-3.3.1.min.js"></script>
<script src="fabric.js"></script>
<script src="canvas-text.js"></script>
<script type="text/javascript">
    var canvas;
    var textControl;
    var selectedObj;
    var color = {
        white: '#ffffff',
        black: '#000000',
        red: '#ff4040',
        orange: '#ff6518',
        yellow: '#ffbb3b',
        green: '#03bd9e',
        light_blue: '#00a9ff',
        blue: '#515ce6',
        purple: '#9e5fff',
        pink: '#ff5583'
    }

    $(document).ready(function() {
        init();
        //addText();
        addTextDefault();
    });

    function init() {
        initCanvas();
        initTextControl();
        initAddTextButton();
        initTextColorPicker();
        selectedObject(null);
        canvas.renderAll();

        function initCanvas() {
            canvas = new fabric.Canvas('myCanvas', {});

            fabric.Canvas.prototype.getAbsoluteCoords = function(object) {
                return {
                    left: object.left + this._offset.left,
                    top: object.top + this._offset.top
                };
            }

            canvas.on('selection:cleared', function() {
                console.log("canvas selection cleared");
                selectedObject(null);
            });

        }

        function initTextControl() {
            textControl = $('.text_control_container');
        }

        function initAddTextButton() {
            $('.addText').click(function() {
                addText();
            });
        }
        
        function initTextColorPicker(){
            $('.color').click(function(){
                let className = $(this).attr('class').split(' ');
                console.log(className[1]);
                console.log(color[className[1]]);
                selectedObj.set({fill: color[className[1]]});
            });
        }
    };

    function addText() {
        var text = new fabric.IText('我是誰 小拳石', {
            fontFamily: 'HanziPen TC',
            left: Math.floor(Math.random() * 800) + 50,
            top: Math.floor(Math.random() * 300) + 50,
        });

        canvas.add(text);

        text.on('moving', function() {
            positionTextControl(text)
        });
        text.on('scaling', function() {
            positionTextControl(text)
        });

        text.on('mouseup', function() {
            console.log("text mouseup");
            selectedObject(text);
        });
    }

    function addTextDefault() {
        var text = new fabric.IText('我是誰 皮卡丘', {
            fontFamily: 'Libian TC',
            left: 50,
            top: 50,
        });

        canvas.add(text);

        text.on('moving', function() {
            positionTextControl(text)
        });
        text.on('scaling', function() {
            positionTextControl(text)
        });

        text.on('mouseup', function() {
            console.log("text mouseup");
            selectedObject(text);
        });
    }

    function changeFont(obj, fontName) {
        obj.fontFamily = fontName;
        canvas.renderAll();
    }

    function selectedObject(obj) {
        selectedObj = obj;
        if (obj == null) {
            textControl.hide();
            return;
        }
        textControl.show();
        positionTextControl(obj);
    }

    function positionTextControl(obj) {
        let absCoords = canvas.getAbsoluteCoords(obj);
        let width = obj.width * obj.scaleX;
        let height = obj.height * obj.scaleY;

        textControl.css({
            "top": absCoords.top,
            "left": absCoords.left + width
        });
    }

    var fontControl = $('#font-control');
    $(document.body).on('change', '#font-control', function() {
        if (selectedObj != null) {
            selectedObj.fontFamily = fontControl.val();
            canvas.renderAll();
        }
    });
</script>